<section id="checkout" class="checkout-hero py-4">
  <div class="container-xxl">
    <div class="row g-4">
      <div class="col-lg-7">
        <div class="card pay-card p-4 shadow-soft">
          <div class="d-flex align-items-center mb-3">
            <span class="badge-dot me-2"></span>
            <h4 class="mb-0">Pagar</h4>
            <span class="ms-auto price-chip fw-bold">USD 50.00</span>
          </div>

          <div class="secure-line mb-3">
            <i class="bi bi-shield-check"></i>
            <small>Pago seguro con PayPal. No compartimos tus datos financieros.</small>
          </div>

          {% if paypal_plan_id %}
          <div id="paypal-button-pro"></div>

          <p class="text-muted mt-3 mb-0" style="font-size:.9rem;">
            Al continuar aceptas nuestros Términos y Política de privacidad. Recibirás el comprobante por correo.
          </p>
          {% else %}
          <div class="alert alert-warning mb-0">Configuración de PayPal pendiente.</div>
          {% endif %}
        </div>
      </div>

      <div class="col-lg-5">
        <div class="card order-card p-4 shadow-soft">
          <div class="d-flex align-items-center mb-3">
            <h5 class="mb-0">Resumen del pedido</h5>
            <span class="ms-2 badge text-bg-secondary">Pro</span>
          </div>
          <ul class="list-unstyled text-muted">
            <li class="mb-1"><i class="bi bi-check2 me-2 text-success"></i>Perfiles avanzados</li>
            <li class="mb-1"><i class="bi bi-check2 me-2 text-success"></i>JEAN personalizado</li>
            <li class="mb-1"><i class="bi bi-check2 me-2 text-success"></i>Métricas y heatmaps</li>
          </ul>

          <hr class="my-3">
          <div class="d-flex align-items-center">
            <small class="text-muted me-2"><i class="bi bi-envelope-open"></i> ¿Dudas?</small>
            <a href="{{ url_for('contacto') }}" class="small">Contáctanos</a>
            <span class="ms-auto fw-semibold">USD 50.00</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

{% if paypal_plan_id %}
{# SDK y botón de suscripción #}
<script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&vault=true&intent=subscription&disable-funding=card,credit,venmo{% if paypal_env=='sandbox' %}&debug=true{% endif %}"></script>
<script>
  const sessionUser = {{ (session.get('user') or '') | tojson }};
  paypal.Buttons({
    style: { layout: 'vertical', color: 'blue', shape: 'rect', label: 'subscribe', tagline: false },
    createSubscription: (data, actions) => actions.subscription.create({ plan_id: '{{ paypal_plan_id }}' }),
    onApprove: (data) => {
      fetch('/api/paypal/subscription-activate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ subscriptionID: data.subscriptionID, email: sessionUser })
      })
        .then(res => {
          if (!res.ok) throw new Error('activation failed');
          return res.json();
        })
        .then(() => {
          window.location.href = "{{ url_for('subscribe_success') }}?sub=" + encodeURIComponent(data.subscriptionID);
        })
        .catch(err => {
          console.error(err);
          alert('Error con PayPal');
        });
    },
    onError: (err) => { console.error(err); alert('Error con PayPal'); }
  }).render('#paypal-button-pro');
</script>
{% endif %}
