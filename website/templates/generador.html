{% extends "base.html" %}
{% block title %}Generador de Turnos v6.2 ‚Äî Sistema Corregido{% endblock %}

{% block content %}
  <h1 class="mb-4">Generador de Turnos v6.2 ‚Äî Sistema Corregido</h1>

  <div class="row g-4">
    <!-- SIDEBAR -->
    <div class="col-12 col-xl-4 col-lg-5">
      <div class="card sidebar">
        <div class="card-body">
          <h5 class="mb-3">‚öôÔ∏è Configuraci√≥n</h5>

          <form id="form-generador" action="/generador" method="POST" enctype="multipart/form-data">
            <!-- Iteraciones / tiempo / solver -->
            <div class="mb-3">
              <label class="form-label">Iteraciones m√°ximas</label>
              <input class="form-control" type="number" name="max_iter" value="30" min="1" />
            </div>
            <div class="mb-3">
              <label class="form-label">Tiempo solver (s)</label>
              <input class="form-control" type="number" name="time_solver" value="240" min="0" />
              <div class="form-text text-muted">0 = sin l√≠mite (no recomendado en modo s√≠ncrono)</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Mostrar progreso solver</label>
              <select class="form-select" name="solver_msg">
                <option value="1" selected>1</option>
                <option value="0">0</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Threads solver (PuLP)</label>
              <input class="form-control" type="number" name="solver_threads" value="1" min="1" />
            </div>
            <div class="mb-3">
              <label class="form-label">Cobertura objetivo (%)</label>
              <input class="form-control" type="number" name="target_coverage" value="98" min="95" max="100" />
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" name="verbose" id="verbose">
              <label class="form-check-label" for="verbose">Modo verbose/debug</label>
            </div>

            <!-- Tipos de contrato -->
            <h6 class="mt-4 mb-2">üìã Tipos de Contrato</h6>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="use_ft" id="use_ft" checked>
              <label class="form-check-label" for="use_ft">Full Time (48h)</label>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" name="use_pt" id="use_pt" checked>
              <label class="form-check-label" for="use_pt">Part Time (24h)</label>
            </div>

            <!-- Turnos FT -->
            <div id="ft_block">
              <h6 class="mt-3 mb-2">‚è∞ Turnos FT Permitidos</h6>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="allow_8h" id="allow_8h" checked>
                <label class="form-check-label" for="allow_8h">8 horas (6 d√≠as)</label>
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" name="allow_10h8" id="allow_10h8">
                <label class="form-check-label" for="allow_10h8">10h + d√≠a de 8h (5 d√≠as)</label>
              </div>
            </div>

            <!-- Breaks -->
            <h6 class="mt-3 mb-2">‚òï Configuraci√≥n de Breaks</h6>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Break desde inicio (horas)</label>
                <input class="form-control" type="number" step="0.5" name="break_from_start" value="2.5" min="1" max="5">
              </div>
              <div class="col-6">
                <label class="form-label">Break antes del fin (horas)</label>
                <input class="form-control" type="number" step="0.5" name="break_from_end" value="2.5" min="1" max="5">
              </div>
            </div>

            <!-- Turnos PT -->
            <div id="pt_block">
              <h6 class="mt-3 mb-2">‚è∞ Turnos PT Permitidos</h6>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="allow_pt_4h" id="allow_pt_4h" checked>
                <label class="form-check-label" for="allow_pt_4h">4 horas (6 d√≠as)</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="allow_pt_6h" id="allow_pt_6h" checked>
                <label class="form-check-label" for="allow_pt_6h">6 horas (4 d√≠as)</label>
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" name="allow_pt_5h" id="allow_pt_5h">
                <label class="form-check-label" for="allow_pt_5h">5 horas (5 d√≠as)</label>
              </div>
            </div>

            <!-- Perfil de optimizaci√≥n (el ‚Äúselector de horarios‚Äù que te falta) -->
            <h6 class="mt-4 mb-2">üéØ Perfil de Optimizaci√≥n</h6>
            <select class="form-select" name="optimization_profile">
              {% for opt in profile_options %}
                <option value="{{opt}}" {% if opt=='JEAN' %}selected{% endif %}>{{opt}}</option>
              {% endfor %}
            </select>
            {% if pulp_available %}
              <div class="alert alert-success mt-3 py-2 mb-2">
                üß† <strong>Solver Inteligente Disponible</strong><br>Programaci√≥n Lineal (PuLP)
              </div>
            {% else %}
              <div class="alert alert-warning mt-3 py-2 mb-2">
                üîÑ <strong>Solver B√°sico Activo</strong><br>Instala <code>pip install pulp</code>
              </div>
            {% endif %}

            <!-- Uploader y bot√≥n -->
            <div class="mt-4">
              <label class="form-label">Archivo de demanda (.xlsx)</label><br>
              <input class="form-control" type="file" name="file" accept=".xlsx" required>
            </div>

            <button class="btn btn-primary w-100 mt-3" type="submit">
              üöÄ Ejecutar Optimizaci√≥n
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- √ÅREA PRINCIPAL: chip ‚ÄúModo Streamlit (s√≠ncrono)‚Äù y ayuda -->
    <div class="col-12 col-xl-8 col-lg-7">
      <div class="card">
        <div class="card-body">
          <span class="chip">Modo Streamlit (s√≠ncrono)</span>
          <p class="mt-3 mb-0 text-muted">
            Sube tu Excel y se calcular√° todo en esta misma p√°gina (sin jobs ni polling).
          </p>
          <div class="dropzone mt-3">
            <strong>Tip:</strong> tambi√©n puedes arrastrar el archivo al campo de la izquierda y presionar
            <em>‚ÄúüöÄ Ejecutar Optimizaci√≥n‚Äù</em>.
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  const ft = document.getElementById('use_ft');
  const pt = document.getElementById('use_pt');
  const ftBlock = document.getElementById('ft_block');
  const ptBlock = document.getElementById('pt_block');
  function refreshBlocks(){
    ftBlock.style.display = ft.checked ? '' : 'none';
    ptBlock.style.display = pt.checked ? '' : 'none';
  }
  ft?.addEventListener('change', refreshBlocks);
  pt?.addEventListener('change', refreshBlocks);
  refreshBlocks();
</script>
{% endblock %}

