{% extends 'base.html' %}
{% block content %}

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0 fw-bold">Generador de Turnos</h2>
    <span class="text-muted small">Replica mejorada del app1 (Streamlit)</span>
  </div>

  <form id="genForm" class="needs-validation" novalidate action="{{ url_for('core.generador') }}" method="post" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <!-- Archivo + Perfil -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-6">
            <label for="excel" class="form-label">Archivo Excel</label>
            <input type="file" class="form-control" id="excel" name="excel" accept=".xlsx" required>
            <div class="invalid-feedback">Sube un archivo .xlsx</div>
          </div>
          <div class="col-md-6">
            <label for="profile" class="form-label">Perfil</label>
            <select class="form-select" id="profile" name="profile" required>
              <option selected>Equilibrado (Recomendado)</option>
              <option>Conservador</option>
              <option>Agresivo</option>
              <option>Máxima Cobertura</option>
              <option>Mínimo Costo</option>
              <option>100% Cobertura Eficiente</option>
              <option>100% Cobertura Total</option>
              <option>Cobertura Perfecta</option>
              <option>100% Exacto</option>
              <option>JEAN</option>
              <option>JEAN Personalizado</option>
              <option>Personalizado</option>
              <option>Aprendizaje Adaptativo</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Acordeón de configuración (nombres deben coincidir con el backend) -->
    <div class="accordion mb-4" id="acc-config">

      <!-- Tipos de contrato -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="head-contracts">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#sec-contracts" aria-expanded="true" aria-controls="sec-contracts">
            Tipos de contrato (FT / PT)
          </button>
        </h2>
        <div id="sec-contracts" class="accordion-collapse collapse show" aria-labelledby="head-contracts" data-bs-parent="#acc-config">
          <div class="accordion-body">
            <div class="row g-3">
              <div class="col-md-3 form-check">
                <input class="form-check-input" type="checkbox" id="use_ft" name="use_ft" checked>
                <label class="form-check-label" for="use_ft">Usar Full Time</label>
              </div>
              <div class="col-md-3 form-check">
                <input class="form-check-input" type="checkbox" id="use_pt" name="use_pt" checked>
                <label class="form-check-label" for="use_pt">Usar Part Time</label>
              </div>

              <div class="col-md-3 form-check">
                <input class="form-check-input" type="checkbox" id="allow_8h" name="allow_8h" checked>
                <label class="form-check-label" for="allow_8h">FT 8 horas</label>
              </div>
              <div class="col-md-3 form-check">
                <input class="form-check-input" type="checkbox" id="allow_10h8" name="allow_10h8">
                <label class="form-check-label" for="allow_10h8">FT 10h + 8h</label>
              </div>
            </div>

            <div class="row g-3 mt-1">
              <div class="col-md-3 form-check">
                <input class="form-check-input" type="checkbox" id="allow_pt_4h" name="allow_pt_4h" checked>
                <label class="form-check-label" for="allow_pt_4h">PT 4h</label>
              </div>
              <div class="col-md-3 form-check">
                <input class="form-check-input" type="checkbox" id="allow_pt_5h" name="allow_pt_5h">
                <label class="form-check-label" for="allow_pt_5h">PT 5h</label>
              </div>
              <div class="col-md-3 form-check">
                <input class="form-check-input" type="checkbox" id="allow_pt_6h" name="allow_pt_6h" checked>
                <label class="form-check-label" for="allow_pt_6h">PT 6h</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Breaks -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="head-breaks">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sec-breaks" aria-expanded="false" aria-controls="sec-breaks">
            Configuración de Breaks
          </button>
        </h2>
        <div id="sec-breaks" class="accordion-collapse collapse" aria-labelledby="head-breaks" data-bs-parent="#acc-config">
          <div class="accordion-body">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label">Break desde inicio (h)</label>
                <input type="number" step="0.5" min="0" class="form-control" name="break_from_start" value="2.0">
              </div>
              <div class="col-md-3">
                <label class="form-label">Break antes del fin (h)</label>
                <input type="number" step="0.5" min="0" class="form-control" name="break_from_end" value="2.0">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Parámetros avanzados -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="head-advanced">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sec-advanced" aria-expanded="false" aria-controls="sec-advanced">
            Parámetros avanzados
          </button>
        </h2>
        <div id="sec-advanced" class="accordion-collapse collapse" aria-labelledby="head-advanced" data-bs-parent="#acc-config">
          <div class="accordion-body">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label">Tiempo del solver (s)</label>
                <input type="number" class="form-control" name="solver_time" value="240">
              </div>
              <div class="col-md-3">
                <label class="form-label">Cobertura objetivo (%)</label>
                <input type="number" step="0.1" class="form-control" name="coverage" value="98">
              </div>
              <div class="col-md-3">
                <label class="form-label">agent_limit_factor</label>
                <input type="number" class="form-control" name="agent_limit_factor" value="12">
              </div>
              <div class="col-md-3">
                <label class="form-label">excess_penalty</label>
                <input type="number" step="0.01" class="form-control" name="excess_penalty" value="2.0">
              </div>
            </div>

            <div class="row g-3 mt-1">
              <div class="col-md-3">
                <label class="form-label">peak_bonus</label>
                <input type="number" step="0.1" class="form-control" name="peak_bonus" value="1.5">
              </div>
              <div class="col-md-3">
                <label class="form-label">critical_bonus</label>
                <input type="number" step="0.1" class="form-control" name="critical_bonus" value="2.0">
              </div>
              <div class="col-md-3">
                <label class="form-label">Iteraciones</label>
                <input type="number" class="form-control" name="iterations" value="30">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Config JEAN -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="head-jean">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sec-jean" aria-expanded="false" aria-controls="sec-jean">
            Plantilla de Configuración (JSON opcional)
          </button>
        </h2>
        <div id="sec-jean" class="accordion-collapse collapse" aria-labelledby="head-jean" data-bs-parent="#acc-config">
          <div class="accordion-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Subir archivo JEAN (.json)</label>
                <input type="file" class="form-control" name="jean_file" accept=".json">
                <div class="form-text">Si se adjunta, sobrescribe los parámetros anteriores.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /accordion -->

    <div class="d-flex align-items-center gap-3">
      <button type="submit" class="btn btn-primary px-4" id="btnExcel">
        Generar Excel
      </button>
      <button type="submit" class="btn btn-secondary px-4" id="btnCharts">
        Generar Gráficas
      </button>
      <div class="spinner-border text-primary d-none" id="spinner" role="status" aria-hidden="true"></div>
      <div class="text-warning-emphasis d-none" id="slowMsg">La generación está tardando más de lo esperado…</div>
    </div>

  </form>

<script src="{{ url_for('static', filename='js/generador.js') }}"></script>
{% endblock %}
