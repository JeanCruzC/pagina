{% extends 'base.html' %}
{% block content %}
<style>
  #sidebar {
    background: #f8f8f8;
    border-radius: 8px;
    padding: 15px;
  }
  #progress-container {
    display: none;
  }
  #results img {
    max-width: 100%;
    height: auto;
  }
  /* Extra styles for results layout */
  .metric-card {
    min-width: 120px;
  }
  #assignments-table td,
  #assignments-table th {
    padding: 0.25rem;
    font-size: 0.85rem;
  }
</style>
<h2 class="mb-4">Generador de Horarios</h2>
<form method="post" enctype="multipart/form-data" id="genForm">
  <div class="row">
    <aside class="col-md-4" id="sidebar">
      <div class="mb-3">
        <label class="form-label">Archivo de demanda</label>
        <input type="file" name="excel" class="form-control" accept=".xlsx" required>
      </div>
      <h5>Configuración</h5>
      <label class="form-label">Iteraciones: <span id="it_val">30</span></label>
      <input type="range" class="form-range" min="10" max="100" value="30" name="iterations" id="iterations">

      <label class="form-label">Tiempo solver (s): <span id="time_val">240</span></label>
      <input type="range" class="form-range" min="60" max="600" step="30" value="240" name="solver_time" id="solver_time">

      <label class="form-label">Cobertura objetivo (%): <span id="cov_val">98</span></label>
      <input type="range" class="form-range" min="95" max="100" value="98" name="coverage" id="coverage">

      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="1" id="ft" name="use_ft" checked>
        <label class="form-check-label" for="ft">Full Time</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="1" id="pt" name="use_pt" checked>
        <label class="form-check-label" for="pt">Part Time</label>
      </div>

      <div id="ft_opts" class="ms-3 mt-2">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="1" name="allow_8h" checked id="allow_8h">
          <label class="form-check-label" for="allow_8h">8 horas</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="1" name="allow_10h8" id="allow_10h8">
          <label class="form-check-label" for="allow_10h8">10h + 8h</label>
        </div>
      </div>

      <div id="pt_opts" class="ms-3 mt-2">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="1" name="allow_pt_4h" checked id="allow_pt_4h">
          <label class="form-check-label" for="allow_pt_4h">PT 4h</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="1" name="allow_pt_6h" checked id="allow_pt_6h">
          <label class="form-check-label" for="allow_pt_6h">PT 6h</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="1" name="allow_pt_5h" id="allow_pt_5h">
          <label class="form-check-label" for="allow_pt_5h">PT 5h</label>
        </div>
      </div>

      <label class="form-label mt-3">Break desde inicio (h): <span id="bstart_val">2.5</span></label>
      <input type="range" class="form-range" min="1" max="5" step="0.5" value="2.5" name="break_from_start" id="break_from_start">

      <label class="form-label">Break antes del fin (h): <span id="bend_val">2.5</span></label>
      <input type="range" class="form-range" min="1" max="5" step="0.5" value="2.5" name="break_from_end" id="break_from_end">

      <label class="form-label mt-3">Perfil de optimización</label>
      <select class="form-select" name="profile" id="profile">
        <option>Equilibrado (Recomendado)</option>
        <option>Conservador</option>
        <option>Agresivo</option>
        <option>Máxima Cobertura</option>
        <option>Mínimo Costo</option>
        <option>100% Cobertura Eficiente</option>
        <option>100% Cobertura Total</option>
        <option>Cobertura Perfecta</option>
        <option>100% Exacto</option>
        <option>JEAN</option>
        <option>JEAN Personalizado</option>
        <option>Personalizado</option>
        <option>Aprendizaje Adaptativo</option>
      </select>

      <div id="personalizado" class="mt-2" style="display:none">
        <label class="form-label">Factor límite agentes</label>
        <input type="number" step="1" min="5" max="35" value="25" class="form-control" name="agent_limit_factor">
        <label class="form-label">Penalización exceso</label>
        <input type="number" step="0.1" value="0.5" class="form-control" name="excess_penalty">
        <label class="form-label">Bonificación pico</label>
        <input type="number" step="0.1" value="1.5" class="form-control" name="peak_bonus">
        <label class="form-label">Bonificación crítica</label>
        <input type="number" step="0.1" value="2.0" class="form-control" name="critical_bonus">
      </div>

      <div id="jean" class="mt-2" style="display:none">
        <label class="form-label">Plantilla JEAN (JSON)</label>
        <input type="file" name="jean_file" class="form-control" accept="application/json">
      </div>
    </aside>

    <section class="col-md-8">
      <button class="btn btn-primary mb-3" type="submit">Generar</button>
      <a href="{{ url_for('logout') }}" class="btn btn-secondary mb-3">Salir</a>

      <div id="progress-container" class="my-3">
        <div class="progress">
          <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%"></div>
        </div>
      </div>

      <div id="results">
        {% if metrics %}
        <h4 class="mt-4">Resultados</h4>
        <div class="row g-2 mb-3" id="metric-cards">
          <div class="col">
            <div class="card metric-card text-center">
              <div class="card-body p-2">
                <div class="fs-4">{{ metrics.total_agents }}</div>
                <small class="text-muted">Agentes</small>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card metric-card text-center">
              <div class="card-body p-2">
                <div class="fs-4">{{ '%.1f'|format(metrics.coverage_percentage) }}%</div>
                <small class="text-muted">Cobertura</small>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card metric-card text-center">
              <div class="card-body p-2">
                <div class="fs-4">{{ metrics.overstaffing }}</div>
                <small class="text-muted">Exceso</small>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card metric-card text-center">
              <div class="card-body p-2">
                <div class="fs-4">{{ metrics.understaffing }}</div>
                <small class="text-muted">Déficit</small>
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-3">
          {% if demand_url %}
          <div class="col-md-6">
            <img src="{{ demand_url }}" alt="Demanda" class="img-fluid mb-3" id="demand-heatmap">
          </div>
          {% endif %}
          {% if image_url %}
          <div class="col-md-6">
            <img src="{{ image_url }}" alt="Cobertura" class="img-fluid mb-3" id="coverage-heatmap">
          </div>
          {% endif %}
        </div>

        {% if assignments_table %}
        <div id="assignments-table" class="table-responsive mb-3">
          {{ assignments_table|safe }}
        </div>
        {% endif %}

        {% if download_url %}
        <p class="mt-2"><a class="btn btn-success" href="{{ download_url }}">Descargar Excel</a></p>
        {% elif download %}
        <p class="mt-2"><a class="btn btn-success" href="{{ url_for('download') }}">Descargar Excel</a></p>
        {% endif %}
        {% endif %}
      </div>
    </section>
  </div>
</form>

<script src="{{ url_for('static', filename='js/generador.js') }}"></script>
<script>
  const ft = document.getElementById('ft');
  const pt = document.getElementById('pt');
  const ft_opts = document.getElementById('ft_opts');
  const pt_opts = document.getElementById('pt_opts');
  function updateContractVisibility() {
    ft_opts.style.display = ft.checked ? 'block' : 'none';
    pt_opts.style.display = pt.checked ? 'block' : 'none';
  }
  ft.addEventListener('change', updateContractVisibility);
  pt.addEventListener('change', updateContractVisibility);
  updateContractVisibility();

  const form = document.getElementById('genForm');
  const progressContainer = document.getElementById('progress-container');
  const progressBar = document.getElementById('progressBar');
  form.addEventListener('submit', () => {
    progressContainer.style.display = 'block';
    progressBar.style.width = '100%';
  });
</script>
{% endblock %}
