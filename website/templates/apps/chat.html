{% extends 'apps/layout.html' %}
{% block app_content %}
<h2 class="fw-bold mb-4">Chat</h2>
<div class="card mb-4">
  <div class="card-body">
    <form method="post" hx-post="{{ url_for('apps.chat') }}" hx-target="#chat-results" hx-swap="innerHTML" class="row g-3">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="col-md-4">
        <label class="form-label">Chats por intervalo</label>
        <input type="number" step="any" name="forecast" class="form-control" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Máximo chats simultáneos</label>
        <div class="input-group">
          <button class="btn btn-outline-secondary" type="button" id="chat-dec">-</button>
          <input type="number" name="max_chats" id="max-chats" class="form-control" value="1" min="1">
          <button class="btn btn-outline-secondary" type="button" id="chat-inc">+</button>
        </div>
      </div>
      <div id="aht-container" class="row g-3"></div>
      <div class="col-md-4">
        <label class="form-label">Agentes</label>
        <input type="number" name="agents" class="form-control" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">AWT (seg)</label>
        <input type="number" step="any" name="awt" class="form-control" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Intervalo</label>
        <select name="interval" class="form-select">
          <option value="1800">30 minutos</option>
          <option value="3600" selected>1 hora</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">SL Objetivo</label>
        <input type="number" step="any" name="sl_target" class="form-control" value="0.8">
      </div>
      <div class="col-12">
        <a class="btn btn-link" data-bs-toggle="collapse" href="#chat-advanced" role="button">Parámetros avanzados</a>
        <div class="collapse" id="chat-advanced">
          <div class="row g-3 mt-0">
            <div class="col-md-4">
              <label class="form-label">Líneas disponibles</label>
              <input type="number" step="any" name="lines" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Patience (seg)</label>
              <input type="number" step="any" name="patience" class="form-control">
            </div>
          </div>
        </div>
      </div>
      <div class="col-12">
        <button class="btn btn-primary" type="submit">Calcular</button>
      </div>
    </form>
  </div>
</div>
<div id="chat-results">
  {% include 'partials/chat_results.html' %}
</div>
<script>
  (function(){
    const inc = document.getElementById('chat-inc');
    const dec = document.getElementById('chat-dec');
    const max = document.getElementById('max-chats');
    const container = document.getElementById('aht-container');

    function renderFields(){
      const n = parseInt(max.value || 0);
      container.innerHTML = '';
      for(let i=1; i<=n; i++){
        const div = document.createElement('div');
        div.className = 'col-md-4';
        div.innerHTML = `<label class="form-label">AHT simultaneidad ${i}</label>` +
                        `<input type="number" step="any" name="ahts" class="form-control">`;
        container.appendChild(div);
      }
    }

    inc.addEventListener('click', ()=>{max.value = parseInt(max.value||0) + 1; renderFields();});
    dec.addEventListener('click', ()=>{max.value = Math.max(1, parseInt(max.value||0) - 1); renderFields();});
    renderFields();
  })();
</script>
{% endblock %}
