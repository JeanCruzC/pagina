{% extends 'apps/layout.html' %}

{% block app_content %}
<h2 class="fw-bold mb-4">Erlang</h2>
<nav class="nav nav-pills mb-4">
  <a class="nav-link {{ 'active' if request.endpoint=='apps.erlang' else '' }}" href="{{ url_for('apps.erlang') }}">Clásico</a>
  <a class="nav-link {{ 'active' if request.endpoint=='apps.erlang_visual_view' else '' }}" href="{{ url_for('apps.erlang_visual_view') }}">Visual</a>
  <a class="nav-link {{ 'active' if request.endpoint=='apps.chat' else '' }}" href="{{ url_for('apps.chat') }}">Chat</a>
  <a class="nav-link {{ 'active' if request.endpoint=='apps.blending' else '' }}" href="{{ url_for('apps.blending') }}">Blending</a>
  <a class="nav-link {{ 'active' if request.endpoint=='apps.erlang_o_view' else '' }}" href="{{ url_for('apps.erlang_o_view') }}">Erlang O</a>
  <a class="nav-link {{ 'active' if request.endpoint=='apps.comparativo' else '' }}" href="{{ url_for('apps.comparativo') }}">Comparativo</a>
  <a class="nav-link {{ 'active' if request.endpoint=='apps.staffing' else '' }}" href="{{ url_for('apps.staffing') }}">Staffing</a>
  <a class="nav-link {{ 'active' if request.endpoint in ['apps.batch', 'apps.batch_download'] else '' }}" href="{{ url_for('apps.batch') }}">Batch</a>
</nav>

<div class="card mb-4">
  <div class="card-body">
    <form id="erlang-form" class="row g-3" method="post">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="col-md-3">
        <label class="form-label">Forecast</label>
        <input type="number" step="any" class="form-control" name="forecast" value="{{ request.form.forecast or 100 }}" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">AHT (segundos)</label>
        <input type="number" step="any" class="form-control" name="aht" value="{{ request.form.aht or 240 }}" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">Agentes</label>
        <input type="number" class="form-control" name="agents" value="{{ request.form.agents or 25 }}" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">SL Objetivo</label>
        <input type="number" step="any" class="form-control" name="sl_target" value="{{ request.form.sl_target or target_sl or 0.8 }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">AWT (segundos)</label>
        <input type="number" step="any" class="form-control" name="awl" value="{{ request.form.awl or 20 }}" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">Agentes Máx</label>
        <input type="number" class="form-control" name="agents_max" value="{{ request.form.agents_max or '' }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Tipo de cálculo</label>
        <select name="calc_type" class="form-select">
          <option value="metrics" {% if request.form.calc_type != 'required_agents' %}selected{% endif %}>Métricas</option>
          <option value="required_agents" {% if request.form.calc_type == 'required_agents' %}selected{% endif %}>Agentes requeridos</option>
        </select>
      </div>
      <div class="col-12">
        <a class="btn btn-link" data-bs-toggle="collapse" href="#erlang-advanced" role="button">Parámetros avanzados</a>
        <div class="collapse" id="erlang-advanced">
          <div class="row g-3 mt-0">
            <div class="col-md-3">
              <label class="form-label">Intervalo (min)</label>
              <input type="number" step="any" class="form-control" name="interval_minutes" value="{{ request.form.interval_minutes or 60 }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Modo</label>
              <select name="erlang_mode" id="erlang-mode" class="form-select">
                <option value="erlang_c" {% if request.form.erlang_mode != 'erlang_x' %}selected{% endif %}>Erlang C</option>
                <option value="erlang_x" {% if request.form.erlang_mode == 'erlang_x' %}selected{% endif %}>Erlang X</option>
              </select>
            </div>
            <div class="col-md-3" id="patience-field">
              <label class="form-label">Patience (seg)</label>
              <input type="number" step="any" class="form-control" name="patience" value="{{ request.form.patience or '' }}">
            </div>
          </div>
        </div>
      </div>
      <div class="col-12">
        <button class="btn btn-primary" type="submit">Calcular</button>
      </div>
    </form>
  </div>
</div>

{% if result %}
<div class="metrics-grid mb-4">
  <div class="metric-card {{ result.metrics.sl_class }}">
    <h3>SL</h3>
    <h2>{{ (result.metrics.service_level * 100)|round(1) }}%</h2>
  </div>
  <div class="metric-card {{ result.metrics.asa_class }}">
    <h3>ASA</h3>
    <h2>{{ result.metrics.asa|round(2) }} seg</h2>
  </div>
  <div class="metric-card {{ result.metrics.occ_class }}">
    <h3>Ocupación</h3>
    <h2>{{ (result.metrics.occupancy * 100)|round(1) }}%</h2>
  </div>
  <div class="metric-card">
    <h3>Liberados por agente</h3>
    <h2>{{ (result.calls_per_agent_req or 0)|round(1) }}</h2>
  </div>
  <div class="metric-card">
    <h3>Diferencia</h3>
    <h2>{{ result.difference }}</h2>
  </div>
</div>

<div class="card mb-4">
  <div class="card-body">
    <h3 class="mb-3">Dimensionamiento</h3>
    <div id="dimension-bar" class="mb-4" data-agents="{{ result.agents }}" data-recommended="{{ result.recommended }}"></div>
    <canvas id="sensitivity-chart"></canvas>
    <div class="mt-3">
      <button class="btn btn-secondary me-2" id="download-csv" type="button">Descargar CSV</button>
      <button class="btn btn-secondary" id="download-excel" type="button">Descargar Excel</button>
    </div>
    <div class="accordion mt-3" id="erlang-methodology">
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading-method">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#methodology-content">
            Metodología y fórmulas
          </button>
        </h2>
        <div id="methodology-content" class="accordion-collapse collapse" data-bs-parent="#erlang-methodology">
          <div class="accordion-body">
            <p>Las métricas se calculan utilizando fórmulas estándar de Erlang.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script id="erlang-data" type="application/json">{{ result | tojson | safe }}</script>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
<script src="{{ url_for('static', filename='js/apps/erlang.js') }}"></script>
{% endblock %}
