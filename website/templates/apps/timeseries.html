{% extends 'apps/_layout.html' %}

{% block app_content %}
<h2 class="fw-bold mb-4">Series</h2>

<div class="card mb-4">
  <div class="card-body">
    <form id="timeseries-form" class="row g-3" method="post" enctype="multipart/form-data">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="col-md-4">
        <label for="file" class="form-label">Archivo CSV/XLSX</label>
        <input type="file" class="form-control" id="file" name="file" required>
      </div>
      <div class="col-md-4">
        <label for="weight_last" class="form-label">Peso última semana</label>
        <input type="range" class="form-range" min="0" max="1" step="0.05" id="weight_last" name="weight_last" value="0.7">
      </div>
      <div class="col-md-4">
        <label for="weight_prev" class="form-label">Peso semanas previas</label>
        <input type="range" class="form-range" min="0" max="1" step="0.05" id="weight_prev" name="weight_prev" value="0.3">
      </div>
      <div class="col-md-4">
        <label for="scope" class="form-label">Ámbito</label>
        <select class="form-select" id="scope" name="scope">
          <option value="Total">Total</option>
          <option value="Última Semana">Última Semana</option>
        </select>
      </div>
      <div class="col-md-4">
        <label for="view" class="form-label">Vista</label>
        <select class="form-select" id="view" name="view">
          <option value="Día">Día</option>
          <option value="Semana">Semana</option>
          <option value="Mes">Mes</option>
        </select>
      </div>
      <div class="col-md-4 align-self-end">
        <button class="btn btn-primary" type="submit">Procesar</button>
      </div>
    </form>
  </div>
</div>

{% if metrics %}
<div class="row g-3 mb-4" id="timeseries-kpis">
  {% for key, value in metrics.items() %}
  <div class="col-md-3">
    <div class="p-3 border rounded text-center">{{ key }}: {{ value }}</div>
  </div>
  {% endfor %}
</div>
{% endif %}

{% if recommendation %}
<div class="alert alert-info" id="timeseries-recommendations">{{ recommendation }}</div>
{% endif %}

{% if weekly_table %}
<div class="card mb-4">
  <div class="card-body">
    <div class="table-responsive">
      <table id="timeseries-weekly-table" class="table table-sm">
        <thead>
          <tr>
            <th>semana_iso</th>
            <th>planificados</th>
            <th>reales</th>
            <th>desvio_abs</th>
            <th>desvio_pct</th>
          </tr>
        </thead>
        <tbody>
          {% for row in weekly_table %}
          <tr>
            <td>{{ row.semana_iso }}</td>
            <td>{{ row.planificados }}</td>
            <td>{{ row.reales }}</td>
            <td>{{ row.desvio_abs }}</td>
            <td>{{ row.desvio_pct }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

{% if heatmap_json or interactive_json %}
<div class="card mb-4">
  <div class="card-body">
    {% if heatmap_json %}
    <div id="timeseries-heatmap" data-figure='{{ heatmap_json | tojson | safe }}'></div>
    {% endif %}
    {% if interactive_json %}
    <div id="timeseries-interactive" data-figure='{{ interactive_json | tojson | safe }}'></div>
    {% endif %}
  </div>
</div>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
  {% if heatmap_json %}
  (function(){
    const el = document.getElementById('timeseries-heatmap');
    const fig = JSON.parse(el.dataset.figure);
    Plotly.react(el, fig.data, fig.layout);
  })();
  {% endif %}
  {% if interactive_json %}
  (function(){
    const el = document.getElementById('timeseries-interactive');
    const fig = JSON.parse(el.dataset.figure);
    Plotly.react(el, fig.data, fig.layout);
  })();
  {% endif %}
</script>
{% endif %}
{% endblock %}
